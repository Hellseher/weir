(in-package #:weir-tests)

(defun %test-voxels ()

  (let ((voxs (voxels:make '(7 7 7))))

    (voxels:setvoxel voxs 0 3 3)
    (voxels:setvoxel voxs 1 3 3)
    (voxels:setvoxel voxs 2 3 3)
    (voxels:setvoxel voxs 3 3 3)
    (voxels:setvoxel voxs 4 3 3)
    (voxels:setvoxel voxs 5 3 3)
    (voxels:setvoxel voxs 6 3 3)
    (voxels:setvoxel voxs 3 2 3)
    (voxels:setvoxel voxs 3 1 3)
    (voxels:setvoxel voxs 0 0 1)

    (let ((msh (voxels:get-mesh voxs)))
      (do-test (mesh:get-all-verts msh)
               '(#s(vec:3vec :x 0.0d0 :y -0.5d0 :z 1.0d0) #s(vec:3vec :x -0.5d0 :y 0.0d0 :z 1.0d0)
                 #s(vec:3vec :x 0.0d0 :y 0.0d0 :z 0.5d0) #s(vec:3vec :x 0.0d0 :y 0.0d0 :z 1.5d0)
                 #s(vec:3vec :x 0.0d0 :y 0.5d0 :z 1.0d0) #s(vec:3vec :x 0.0d0 :y 2.5d0 :z 3.0d0)
                 #s(vec:3vec :x -0.5d0 :y 3.0d0 :z 3.0d0) #s(vec:3vec :x 0.0d0 :y 3.0d0 :z 2.5d0)
                 #s(vec:3vec :x 0.0d0 :y 3.0d0 :z 3.5d0) #s(vec:3vec :x 0.0d0 :y 3.5d0 :z 3.0d0)
                 #s(vec:3vec :x 0.5d0 :y 0.0d0 :z 1.0d0) #s(vec:3vec :x 1.0d0 :y 3.0d0 :z 2.5d0)
                 #s(vec:3vec :x 1.0d0 :y 2.5d0 :z 3.0d0) #s(vec:3vec :x 1.0d0 :y 3.0d0 :z 3.5d0)
                 #s(vec:3vec :x 1.0d0 :y 3.5d0 :z 3.0d0) #s(vec:3vec :x 2.0d0 :y 3.0d0 :z 2.5d0)
                 #s(vec:3vec :x 2.0d0 :y 2.5d0 :z 3.0d0) #s(vec:3vec :x 2.0d0 :y 3.0d0 :z 3.5d0)
                 #s(vec:3vec :x 2.0d0 :y 3.5d0 :z 3.0d0) #s(vec:3vec :x 3.0d0 :y 0.5d0 :z 3.0d0)
                 #s(vec:3vec :x 2.5d0 :y 1.0d0 :z 3.0d0) #s(vec:3vec :x 3.0d0 :y 1.0d0 :z 2.5d0)
                 #s(vec:3vec :x 3.0d0 :y 1.0d0 :z 3.5d0) #s(vec:3vec :x 2.5d0 :y 2.0d0 :z 3.0d0)
                 #s(vec:3vec :x 3.0d0 :y 2.0d0 :z 2.5d0) #s(vec:3vec :x 3.0d0 :y 2.0d0 :z 3.5d0)
                 #s(vec:3vec :x 3.0d0 :y 3.0d0 :z 2.5d0) #s(vec:3vec :x 3.0d0 :y 3.0d0 :z 3.5d0)
                 #s(vec:3vec :x 3.0d0 :y 3.5d0 :z 3.0d0) #s(vec:3vec :x 3.5d0 :y 1.0d0 :z 3.0d0)
                 #s(vec:3vec :x 3.5d0 :y 2.0d0 :z 3.0d0) #s(vec:3vec :x 4.0d0 :y 3.0d0 :z 2.5d0)
                 #s(vec:3vec :x 4.0d0 :y 2.5d0 :z 3.0d0) #s(vec:3vec :x 4.0d0 :y 3.0d0 :z 3.5d0)
                 #s(vec:3vec :x 4.0d0 :y 3.5d0 :z 3.0d0) #s(vec:3vec :x 5.0d0 :y 3.0d0 :z 2.5d0)
                 #s(vec:3vec :x 5.0d0 :y 2.5d0 :z 3.0d0) #s(vec:3vec :x 5.0d0 :y 3.0d0 :z 3.5d0)
                 #s(vec:3vec :x 5.0d0 :y 3.5d0 :z 3.0d0) #s(vec:3vec :x 6.0d0 :y 3.0d0 :z 2.5d0)
                 #s(vec:3vec :x 6.0d0 :y 2.5d0 :z 3.0d0) #s(vec:3vec :x 6.0d0 :y 3.0d0 :z 3.5d0)
                 #s(vec:3vec :x 6.0d0 :y 3.5d0 :z 3.0d0) #s(vec:3vec :x 6.5d0 :y 3.0d0 :z 3.0d0)))

      (do-test (mesh:get-all-polygons msh)
               '((0 1 2) (0 3 1) (1 4 2) (1 3 4) (5 6 7) (5 8 6) (6 9 7) (6 8 9) (0 2 10)
                 (0 10 3) (2 4 10) (3 10 4) (5 11 12) (5 7 11) (5 12 8) (8 12 13) (7 14 11)
                 (7 9 14) (8 13 9) (9 13 14) (12 15 16) (11 15 12) (12 16 13) (13 16 17)
                 (11 18 15) (11 14 18) (13 17 14) (14 17 18) (19 20 21) (19 22 20) (21 23 24)
                 (20 23 21) (20 25 23) (20 22 25) (16 24 23) (15 24 16) (15 26 24) (16 23 17)
                 (17 23 25) (17 25 27) (15 28 26) (15 18 28) (17 27 18) (18 27 28) (19 21 29)
                 (19 29 22) (21 24 29) (24 30 29) (22 29 30) (22 30 25) (30 31 32) (24 31 30)
                 (24 26 31) (25 30 32) (25 32 33) (25 33 27) (26 34 31) (26 28 34) (27 33 28)
                 (28 33 34) (32 35 36) (31 35 32) (32 36 33) (33 36 37) (31 38 35) (31 34 38)
                 (33 37 34) (34 37 38) (36 39 40) (35 39 36) (36 40 37) (37 40 41) (35 42 39)
                 (35 38 42) (37 41 38) (38 41 42) (39 43 40) (40 43 41) (39 42 43) (41 43 42))))))


(define-file-tests test-voxels ()
  (test-title (%test-voxels)))
